pipeline {
  agent {
    node {
      label 'docker-daemon'
    }
  }

  tools { nodejs "v9.9.0" }
  environment {
    imageName = "tracking-opt-in-demo"
    currentCommit = sh(returnStdout: true, script: "git log -n 1 --pretty=format:'%h'").trim()
    dockerRepoUrl = "${env.DOCKER_REPO_URL}"
    serviceName = "${imageName}-${currentCommit}"
    appHost = "${env.APP_HOST_PREFIX}${currentCommit}${env.APP_HOST_SUFFIX}"
    appNamespace = "dev"
  }

  stages {

    stage('dependencies') {
      steps {
        sh "yarn install --frozen-lockfile"
      }
    }

    stage('tests') {
      steps {
        sh "yarn test"
      }
    }

    stage('build app') {
      steps {
        sh "yarn build"
      }
    }

    stage('start test container') {
      steps {
        sh "docker build --file release/demo-container/Dockerfile --tag ${imageName}:${currentCommit} ."
        sh "docker tag ${imageName}:${currentCommit} ${dockerRepoUrl}/${imageName}:${currentCommit}"
        sh "docker push ${dockerRepoUrl}/${imageName}:${currentCommit}"
        sh "" \
            "APP_HOST=\"${appHost}\" " \
            "IMAGE=\"${dockerRepoUrl}/${imageName}:${currentCommit}\" " \
            "INSTANCES=1" \
            "NAMESPACE=\"${appNamespace}\" " \
            "SERVICE_NAME=\"${serviceName}\" " \
            "node release/scripts/generate-k8s-yaml.js > release/k8s.yaml"
      }
    }

    stage('BrowserStack') {
      steps {
        sh "echo '...running the browserstack tests...'"
      }
    }

    stage('stop test container') {
      steps {
        sh "echo '...stopping the demo container...'"
      }
    }

    stage('release') {
      steps {
        sh "echo '...creating tag and releasing to npm...'"
      }
    }
  }

  post {
    success {
      sh "echo success"
      // slackSend (channel: '#cake-team-tech', color: 'good', failOnError: true, message: ":shipit: -> tracking-opt-in on ${params.branch} :fandom2017: :flag-eu: :gdpr: :ok_hand:!")
    }

    failure {
      sh "echo failed"
      // slackSend (channel: '#cake-team-tech', color: 'warning', failOnError: true, message: ":sadface: Release of tracking-opt-in on ${params.branch} :flag-eu: :gdpr: :doom_look: failed!")
    }
  }
}
